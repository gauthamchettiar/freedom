{{- /*
Renders a menu for the given menu ID.

@context {page} page The current page.
@context {string} menuID The menu ID.
@context {string} withParentId Optional. If provided, only renders children of the specified parent menu item.

@example: {{ partial "menu.html" (dict "menuID" "main" "page" .) }}
@example: {{ partial "menu.html" (dict "menuID" "main" "page" . "withParentId" "Documentation") }}
*/}}

{{ $page := .page }}
{{ $site := .site }}
{{ $menuID := .menuID }}
{{ $withParentId := .withParentId | default "" }}
{{ $key := .key | default "showMenu" }}
{{ $class := .class | default "" }}

{{ $showMenu := (partial "config.html" (dict "page" $page "site" $site "key" $key)) }}

{{- if not $showMenu -}}
  {{- return -}}
{{- end -}}

{{- with index site.Menus $menuID }}
  <nav role="navigation" aria-label="{{ $menuID }} navigation">
    <ul class="menu menu-{{ $menuID }} {{ $class }}">
      {{- if $withParentId }}
        {{- partial "inline/menu/walk-children.html" (dict "page" $page "menuEntries" . "parentId" $withParentId) }}
      {{- else }}
        {{- partial "inline/menu/walk.html" (dict "page" $page "menuEntries" .) }}
      {{- end }}
    </ul>
  </nav>
{{- end }}

{{- define "_partials/inline/menu/walk.html" }}
  {{- $page := .page }}
  {{- range .menuEntries }}
    {{- $attrs := dict "href" .URL }}
    {{- $isActive := false }}
    
    {{- /* Check if this is the current page or menu item */}}
    {{- if $page.IsMenuCurrent .Menu . }}
      {{- $isActive = true }}
    {{- else if $page.HasMenuCurrent .Menu . }}
      {{- $isActive = true }}
    {{- else }}
      {{- /* Also check if current section/type matches the menu URL */}}
      {{- $menuPath := .URL | strings.TrimSuffix "/" }}
      {{- $currentSection := printf "/%s" $page.Section }}
      {{- $currentType := printf "/%s" $page.Type }}
      {{- if or (eq $menuPath $currentSection) (eq $menuPath $currentType) }}
        {{- $isActive = true }}
      {{- end }}
    {{- end }}
    
    {{- if $isActive }}
      {{- $attrs = merge $attrs (dict "class" "active" "aria-current" "page") }}
    {{- end }}
    
    {{- $name := .Name }}
    {{- with .Identifier }}
      {{- with T . }}
        {{- $name = . }}
      {{- end }}
    {{- end }}
    <li>
      <a
        {{- range $k, $v := $attrs }}
          {{- with $v }}
            {{- printf " %s=%q" $k $v | safeHTMLAttr }}
          {{- end }}
        {{- end -}}
      >{{ $name }}</a>
    </li>
  {{- end }}
{{- end }}

{{- define "_partials/inline/menu/walk-children.html" }}
  {{- $page := .page }}
  {{- $parentId := .parentId }}
  {{- range .menuEntries }}
    {{- if eq .Name $parentId }}
      {{- range .Children }}
        {{- partial "inline/menu/walk.html" (dict "page" $page "menuEntries" .) }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
