{{- /*
Renders a menu for the given menu ID.

@context {page} page The current page.
@context {string} menuID The menu ID.
@context {string} withParentId Optional. If provided, only renders children of the specified parent menu item.

@example: {{ partial "menu.html" (dict "menuID" "main" "page" .) }}
@example: {{ partial "menu.html" (dict "menuID" "main" "page" . "withParentId" "Documentation") }}
*/}}


{{ $menuID := .menuID }}
{{ $withParentId := .withParentId | default "" }}
{{ $key := .key | default "Menu" }}
{{ $class := .class | default "" }}

{{ $showMenu := (partial "utils/config.html" (dict  "key" (print "show" $key) "default" true)) }}

{{- if not $showMenu -}}
  {{- return -}}
{{- end -}}

{{- with index site.Menus $menuID }}
  {{- /* Find active parent with children for submenu display */ -}}
  {{- $activeParent := "" -}}
  {{- $activeSubParent := "" -}}
  
  {{- /* Helper to check if menu item or descendants are active */ -}}
  {{- $checkActive := dict -}}
  
  {{- range . -}}
    {{- if .Children -}}
      {{- $isParentActive := false -}}
      
      {{- /* Check if parent is active */ -}}
      {{- if page.IsMenuCurrent .Menu . -}}
        {{- $isParentActive = true -}}
      {{- else if page.HasMenuCurrent .Menu . -}}
        {{- $isParentActive = true -}}
      {{- else -}}
        {{- $menuPath := .URL | strings.TrimSuffix "/" -}}
        {{- $currentSection := printf "/%s" page.Section -}}
        {{- $currentType := printf "/%s" page.Type -}}
        {{- if or (eq $menuPath $currentSection) (eq $menuPath $currentType) -}}
          {{- $isParentActive = true -}}
        {{- end -}}
      {{- end -}}
      
      {{- /* Check if any child is active (including grandchildren) */ -}}
      {{- if not $isParentActive -}}
        {{- range .Children -}}
          {{- if page.IsMenuCurrent .Menu . -}}
            {{- $isParentActive = true -}}
          {{- else if page.HasMenuCurrent .Menu . -}}
            {{- $isParentActive = true -}}
          {{- else -}}
            {{- $childPath := .URL | strings.TrimSuffix "/" -}}
            {{- $currentSection := printf "/%s" page.Section -}}
            {{- $currentType := printf "/%s" page.Type -}}
            {{- if or (eq $childPath $currentSection) (eq $childPath $currentType) -}}
              {{- $isParentActive = true -}}
            {{- end -}}
          {{- end -}}
          
          {{- /* Check grandchildren */ -}}
          {{- if and (not $isParentActive) .Children -}}
            {{- range .Children -}}
              {{- if page.IsMenuCurrent .Menu . -}}
                {{- $isParentActive = true -}}
              {{- else if page.HasMenuCurrent .Menu . -}}
                {{- $isParentActive = true -}}
              {{- else -}}
                {{- $grandchildPath := .URL | strings.TrimSuffix "/" -}}
                {{- $currentSection := printf "/%s" page.Section -}}
                {{- $currentType := printf "/%s" page.Type -}}
                {{- if or (eq $grandchildPath $currentSection) (eq $grandchildPath $currentType) -}}
                  {{- $isParentActive = true -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
      
      {{- if $isParentActive -}}
        {{- $activeParent = .Name -}}
        
        {{- /* Find active sub-parent (child with children that is active) */ -}}
        {{- range .Children -}}
          {{- if .Children -}}
            {{- $isSubParentActive := false -}}
            
            {{- if page.IsMenuCurrent .Menu . -}}
              {{- $isSubParentActive = true -}}
            {{- else if page.HasMenuCurrent .Menu . -}}
              {{- $isSubParentActive = true -}}
            {{- else -}}
              {{- $subMenuPath := .URL | strings.TrimSuffix "/" -}}
              {{- $currentSection := printf "/%s" page.Section -}}
              {{- $currentType := printf "/%s" page.Type -}}
              {{- if or (eq $subMenuPath $currentSection) (eq $subMenuPath $currentType) -}}
                {{- $isSubParentActive = true -}}
              {{- end -}}
            {{- end -}}
            
            {{- /* Check if any grandchild is active */ -}}
            {{- if not $isSubParentActive -}}
              {{- range .Children -}}
                {{- if page.IsMenuCurrent .Menu . -}}
                  {{- $isSubParentActive = true -}}
                {{- else if page.HasMenuCurrent .Menu . -}}
                  {{- $isSubParentActive = true -}}
                {{- else -}}
                  {{- $grandchildPath := .URL | strings.TrimSuffix "/" -}}
                  {{- $currentSection := printf "/%s" page.Section -}}
                  {{- $currentType := printf "/%s" page.Type -}}
                  {{- if or (eq $grandchildPath $currentSection) (eq $grandchildPath $currentType) -}}
                    {{- $isSubParentActive = true -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
            
            {{- if $isSubParentActive -}}
              {{- $activeSubParent = .Name -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- /* Render main menu */ -}}
  <nav role="navigation" aria-label="{{ $menuID }} navigation">
    <ul class="menu menu-{{ $menuID }} {{ $class }}">
      {{- if $withParentId }}
        {{- partial "inline/menu/walk-children.html" (dict "menuEntries" . "parentId" $withParentId) }}
      {{- else }}
        {{- partial "inline/menu/walk.html" (dict "menuEntries" . "activeParent" $activeParent) }}
      {{- end }}
    </ul>
  </nav>
  
  {{- /* Render first level submenu if active parent has children */ -}}
  {{- if and $activeParent (not $withParentId) -}}
    <nav role="navigation" aria-label="{{ $menuID }} submenu navigation" class="submenu-nav">
      <ul class="menu menu-{{ $menuID }}-sub submenu">
        {{- partial "inline/menu/walk-children.html" (dict "menuEntries" . "parentId" $activeParent "activeParent" $activeSubParent) }}
      </ul>
    </nav>
  {{- end -}}
  
  {{- /* Render second level submenu if active sub-parent has children */ -}}
  {{- if and $activeSubParent (not $withParentId) -}}
    <nav role="navigation" aria-label="{{ $menuID }} sub-submenu navigation" class="submenu-nav submenu-level-2">
      <ul class="menu menu-{{ $menuID }}-subsub submenu submenu-level-2">
        {{- partial "inline/menu/walk-grandchildren.html" (dict "menuEntries" . "parentId" $activeParent "subParentId" $activeSubParent) }}
      </ul>
    </nav>
  {{- end -}}
{{- end }}

{{- define "_partials/inline/menu/walk.html" }}
  {{- $activeParent := .activeParent | default "" -}}
  {{- range .menuEntries }}
    {{- $attrs := dict "href" .URL }}
    {{- $isActive := false }}
    {{- $isParentOfActive := and .Children (eq .Name $activeParent) -}}
    
    {{- /* Check if this is the current page or menu item */}}
    {{- if page.IsMenuCurrent .Menu . }}
      {{- $isActive = true }}
    {{- else if page.HasMenuCurrent .Menu . }}
      {{- $isActive = true }}
    {{- else }}
      {{- /* Also check if current section/type matches the menu URL */}}
      {{- $menuPath := .URL | strings.TrimSuffix "/" }}
      {{- $currentSection := printf "/%s" page.Section }}
      {{- $currentType := printf "/%s" page.Type }}
      {{- if or (eq $menuPath $currentSection) (eq $menuPath $currentType) }}
        {{- $isActive = true }}
      {{- end }}
    {{- end }}
    
    {{- /* Mark as active if this is the parent of the active submenu */ -}}
    {{- if $isParentOfActive }}
      {{- $isActive = true }}
    {{- end }}
    
    {{- if $isActive }}
      {{- $attrs = merge $attrs (dict "class" "active" "aria-current" "page") }}
    {{- end }}
    
    {{- $name := .Name }}
    {{- with .Identifier }}
      {{- with T . }}
        {{- $name = . }}
      {{- end }}
    {{- end }}
    <li>
      <a
        {{- range $k, $v := $attrs }}
          {{- with $v }}
            {{- printf " %s=%q" $k $v | safeHTMLAttr }}
          {{- end }}
        {{- end -}}
      >{{ $name }}</a>
    </li>
  {{- end }}
{{- end }}

{{- define "_partials/inline/menu/walk-children.html" }}
  {{- $parentId := .parentId }}
  {{- $activeParent := .activeParent | default "" }}
  {{- range .menuEntries }}
    {{- if eq .Name $parentId }}
      {{- with .Children }}
        {{- partial "inline/menu/walk.html" (dict "menuEntries" . "activeParent" $activeParent) }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- define "_partials/inline/menu/walk-grandchildren.html" }}
  {{- $parentId := .parentId }}
  {{- $subParentId := .subParentId }}
  {{- range .menuEntries }}
    {{- if eq .Name $parentId }}
      {{- range .Children }}
        {{- if eq .Name $subParentId }}
          {{- with .Children }}
            {{- partial "inline/menu/walk.html" (dict "menuEntries" .) }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
