{{- /*
  Table of Contents Widget
  
  Displays a table of contents for the current page based on headings.
  Parses headers from content and generates nested unordered lists.
  
  Parameters:
    - page (required): Page context
    - site (required): Site context
    - title (optional): TOC heading title (default: "Table of Contents")
    - class (optional): Additional CSS classes
    - key (optional): Config key for visibility (default: "showToc")
  
  Example:
    {{ partial "widgets/meta/toc.html" (dict "page" . "site" .Site) }}
    {{ partial "widgets/meta/toc.html" (dict "page" . "site" .Site "title" "On This Page") }}
*/ -}}

{{- $page := .page -}}
{{- $site := .site -}}
{{- $key := .key | default "showToc" -}}
{{- $title := .title | default "" -}}
{{- $class := .class | default "" -}}

{{- $showToc := partial "config.html" (dict "page" $page "site" $site "key" $key) -}}

{{- $headers := findRE "<h[1-6].*?>(.|\n])+?</h[1-6]>" $page.Content -}}
{{- $hasHeaders := ge (len $headers) 1 -}}

{{- if and $showToc $hasHeaders -}}
<nav class="toc {{ $class }}" aria-label="Table of Contents">
  {{- if $title -}}
  <h4 class="toc-title">{{ $title }}</h4>
  {{- end -}}
  
  {{- $largest := 6 -}}
  {{- range $headers -}}
    {{- $headerLevel := index (findRE "[1-6]" . 1) 0 -}}
    {{- $headerLevel := len (seq $headerLevel) -}}
    {{- if lt $headerLevel $largest -}}
      {{- $largest = $headerLevel -}}
    {{- end -}}
  {{- end -}}

  {{- $firstHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers 0) 1) 0)) -}}
  {{- $page.Scratch.Set "bareul" slice -}}
  
  <ul class="toc-list">
    {{- range seq (sub $firstHeaderLevel $largest) -}}
      <ul class="toc-list">
        {{- $page.Scratch.Add "bareul" (sub (add $largest .) 1) -}}
    {{- end -}}
      
      {{- range $i, $header := $headers -}}
        {{- $headerLevel := index (findRE "[1-6]" . 1) 0 -}}
        {{- $headerLevel := len (seq $headerLevel) -}}
        
        {{- $id := index (findRE "(id=\"(.*?)\")" $header 9) 0 -}}
        {{- $cleanedID := replace (replace $id "id=\"" "") "\"" "" -}}
        {{- $header := replaceRE "<h[1-6].*?>((.|\n])+?)</h[1-6]>" "$1" $header -}}
        
        {{- if ne $i 0 -}}
          {{- $prevHeaderLevel := index (findRE "[1-6]" (index $headers (sub $i 1)) 1) 0 -}}
          {{- $prevHeaderLevel := len (seq $prevHeaderLevel) -}}
          
          {{- if gt $headerLevel $prevHeaderLevel -}}
            {{- range seq $prevHeaderLevel (sub $headerLevel 1) -}}
              <ul class="toc-list">
                {{- if ne $prevHeaderLevel . -}}
                  {{- $page.Scratch.Add "bareul" . -}}
                {{- end -}}
            {{- end -}}
          {{- else -}}
            </li>
            {{- if lt $headerLevel $prevHeaderLevel -}}
              {{- range seq (sub $prevHeaderLevel 1) -1 $headerLevel -}}
                {{- if in ($page.Scratch.Get "bareul") . -}}
                  </ul>
                  {{- $tmp := $page.Scratch.Get "bareul" -}}
                  {{- $page.Scratch.Delete "bareul" -}}
                  {{- $page.Scratch.Set "bareul" slice -}}
                  {{- range seq (sub (len $tmp) 1) -}}
                    {{- $page.Scratch.Add "bareul" (index $tmp (sub . 1)) -}}
                  {{- end -}}
                {{- else -}}
                  </ul></li>
                {{- end -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
        
        <li class="toc-item">
          <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | plainify | safeHTML -}}</a>
      {{- end -}}
      
      {{- $firstHeaderLevel := $largest -}}
      {{- $lastHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers (sub (len $headers) 1)) 1) 0)) -}}
      </li>
      
      {{- range seq (sub $lastHeaderLevel $firstHeaderLevel) -}}
        {{- if in ($page.Scratch.Get "bareul") (add . $firstHeaderLevel) -}}
          </ul>
        {{- else -}}
          </ul></li>
        {{- end -}}
      {{- end -}}
    </ul>
</nav>
{{- end -}}





