{{- /*
Configuration Resolver

Resolves configuration values from multiple sources in priority order:
1. Page frontmatter (.Params)
2. Section-specific site params (site.Params.SECTION.key)
3. Page kind params (site.Params.KIND.key) 
4. Type-specific site params (site.Params.type.TYPE.key)
5. Global site params (site.Params.key)
6. Default value (if provided)

This partial uses Hugo's global page and site functions internally,
so it can be called from any template context.

Parameters:
  - key (required): Configuration key to resolve (case-insensitive)
  - default (optional): Default value if key not found

Returns:
  The resolved configuration value

Examples:
  {{ partial "utils/config.html" (dict "key" "showTitle") }}
  {{ partial "utils/config.html" (dict "key" "showTitle" "default" true) }}
*/ -}}

{{- $key := .key | lower -}}
{{- $value := .default -}} {{/* Default value */}}

{{- $pageContext := page -}}
{{- $siteParams := site.Params -}}

{{- if isset $siteParams $key -}}
  {{- $value = (index $siteParams $key) -}} {{/* Site Wide Params */}}
{{- end -}}

{{- $supportedPageFilters := (dict "kind" $pageContext.Kind "section" $pageContext.Section "type" $pageContext.Type ) -}} {{/* Ordered from least to most granular, in order of application */}}

{{- range $filter, $pageValue := $supportedPageFilters -}}
  {{- if and $pageValue (isset $siteParams $filter) -}}
    {{- $filterParams := index $siteParams $filter -}}
    {{- if and $filterParams (isset $filterParams $pageValue) -}}
      {{- $pageValueParams := index $filterParams $pageValue -}}
      {{- if and $pageValueParams (isset $pageValueParams $key) -}}
        {{- $value = (index $pageValueParams $key) -}} {{/* Site Wide Params, Page Filter Specific Config. Overrides above config. */}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}


{{- $pageKind := $pageContext.Kind -}}
{{- if and $pageKind (isset $siteParams $pageKind) -}}
  {{- $kindParams := index $siteParams $pageKind -}}
  {{- if and $kindParams (isset $kindParams $key) -}}
    {{- $value = (index $kindParams $key) -}} {{/* Site Wide Params, Page Kind Specific Config. Overrides above config. */}}
  {{- end -}}
{{- end -}}

{{- $pageSection := $pageContext.Section -}}
{{- if and $pageSection (isset $siteParams $pageSection) -}}
  {{- $sectionParams := index $siteParams $pageSection -}}
  {{- if and $sectionParams (isset $sectionParams $key) -}}
    {{- $value = (index $sectionParams $key) -}} {{/* Site Wide Params, Page Section Specific Config. Overrides above config. */}}
  {{- end -}}
{{- end -}}

{{- if isset $pageContext.Params $key -}}
  {{- $value = (index $pageContext.Params $key) -}} {{/* Page Params, from Front Matter. Overrides above config. */}}
{{- end -}}

{{- return $value -}}