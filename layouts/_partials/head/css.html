{{- /*
  CSS Bundle Builder
  
  Concatenates all CSS files from theme, main, secondary, widgets, layouts, chroma, and override.
  Chroma syntax highlighting styles are bundled with theme-specific selectors:
  - Light theme: Applied to light mode and system preference light
  - Dark theme: Applied to dark mode and system preference dark
  Minifies and fingerprints in production mode.
  
  Context:
    Standard page context (.)
  
  Example:
    {{ partialCached "head/css.html" . }}
*/ -}}

{{- $themeFile := resources.Get "css/theme.css" -}}
{{- $themeOverrides := partial "head/theme.html" . -}}
{{- $mainFile := resources.Get "css/main.css" -}}
{{- $secondaryFile := resources.Get "css/secondary.css" -}}

{{- $widgetFiles := slice }}
{{- range (resources.Match "css/widgets/*.css") }}
  {{- $widgetFiles = $widgetFiles | append . }}
{{- end }}

{{- $layoutFiles := slice }}
{{- range (resources.Match "css/layouts/*.css") }}
  {{- $layoutFiles = $layoutFiles | append . }}
{{- end }}

{{- /* Load theme-scoped chroma syntax highlighting styles */ -}}
{{- $chromaStyles := partial "utils/load-chroma.html" . -}}
{{- $chromaLight := index $chromaStyles 0 -}}
{{- $chromaDark := index $chromaStyles 1 -}}

{{- $overrideFile := resources.Get "css/override.css" -}}

{{- $cssFiles := slice $themeFile $themeOverrides $mainFile $secondaryFile | append $widgetFiles | append $layoutFiles | append $chromaLight | append $chromaDark | append $overrideFile -}}
{{- $cssBundle := $cssFiles | resources.Concat "css/bundle.css" -}}

{{- with $cssBundle }}
  {{- if hugo.IsDevelopment }}
    <link rel="stylesheet" href="{{ .RelPermalink }}">
  {{- else }}
    {{- with . | minify | fingerprint }}
      <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
    {{- end }}
  {{- end }}
{{- end }}
