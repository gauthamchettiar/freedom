{{- /*
  CSS Bundle Builder
  
  Concatenates all CSS files from theme, main, secondary, widgets, layouts, and override.
  Minifies and fingerprints in production mode.
  
  Context:
    Standard page context (.)
  
  Example:
    {{ partialCached "head/css.html" . }}
*/ -}}

{{- $themeFile := resources.Get "css/theme.css" -}}
{{- $themeOverrides := partial "head/theme.html" . -}}
{{- $mainFile := resources.Get "css/main.css" -}}
{{- $secondaryFile := resources.Get "css/secondary.css" -}}

{{- $widgetFiles := slice }}
{{- range (resources.Match "css/widgets/*.css") }}
  {{- $widgetFiles = $widgetFiles | append . }}
{{- end }}

{{- $layoutFiles := slice }}
{{- range (resources.Match "css/layouts/*.css") }}
  {{- $layoutFiles = $layoutFiles | append . }}
{{- end }}

{{- $overrideFile := resources.Get "css/override.css" -}}

{{- $cssFiles := slice $themeFile $themeOverrides $mainFile $secondaryFile | append $widgetFiles | append $layoutFiles | append $overrideFile -}}
{{- $cssBundle := $cssFiles | resources.Concat "css/bundle.css" -}}

{{- with $cssBundle }}
  {{- if hugo.IsDevelopment }}
    <link rel="stylesheet" href="{{ .RelPermalink }}">
  {{- else }}
    {{- with . | minify | fingerprint }}
      <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous">
    {{- end }}
  {{- end }}
{{- end }}
